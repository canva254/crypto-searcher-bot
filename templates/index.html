<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Arbitrage Bot</title>
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Crypto Arbitrage Bot</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/opportunities">Opportunities</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settings">Settings</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Arbitrage Dashboard</h5>
                        <div>
                            <button id="scannerStatusBtn" class="btn btn-sm btn-success">
                                <i data-feather="play"></i> Scanner Active
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info scanner-status">
                            <i data-feather="info"></i> The scanner is running and checking for opportunities every <span id="scanIntervalDisplay">3</span> seconds.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-dark mb-3">
                                    <div class="card-header">Recent Opportunities</div>
                                    <div class="card-body">
                                        <div id="recentOpportunities" class="recent-opportunities">
                                            <p class="text-muted">Waiting for opportunities...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-dark mb-3">
                                    <div class="card-header">Profit History</div>
                                    <div class="card-body">
                                        <canvas id="profitChart" width="400" height="250"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">Top Opportunities</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>Pair</th>
                                        <th>Buy @ Exchange</th>
                                        <th>Sell @ Exchange</th>
                                        <th>Profit %</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="topOpportunitiesTable">
                                    <tr>
                                        <td colspan="5" class="text-center">No opportunities found yet</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">Statistics</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card bg-dark h-100">
                                    <div class="card-body text-center">
                                        <h3 class="text-info" id="totalOpportunities">0</h3>
                                        <p class="card-text">Total Opportunities</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card bg-dark h-100">
                                    <div class="card-body text-center">
                                        <h3 class="text-success" id="successfulTrades">0</h3>
                                        <p class="card-text">Successful Trades</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card bg-dark h-100">
                                    <div class="card-body text-center">
                                        <h3 class="text-warning" id="avgProfitPerc">0%</h3>
                                        <p class="card-text">Avg. Profit %</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card bg-dark h-100">
                                    <div class="card-body text-center">
                                        <h3 class="text-primary" id="totalProfit">$0.00</h3>
                                        <p class="card-text">Total Profit</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Opportunity Alert Modal -->
    <div class="modal fade" id="opportunityAlert" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Profitable Opportunity Found!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="opportunityDetails">
                        <div class="mb-3">
                            <strong>Token Pair:</strong> <span id="modalTokenPair"></span>
                        </div>
                        <div class="mb-3">
                            <strong>Buy on:</strong> <span id="modalBuyExchange"></span> at <span id="modalBuyPrice"></span>
                        </div>
                        <div class="mb-3">
                            <strong>Sell on:</strong> <span id="modalSellExchange"></span> at <span id="modalSellPrice"></span>
                        </div>
                        <div class="mb-3">
                            <strong>Price Difference:</strong> <span id="modalPriceDiff"></span>%
                        </div>
                        <div class="mb-3">
                            <strong>Estimated Profit:</strong> <span id="modalProfit"></span>%
                        </div>
                        <div class="mb-3">
                            <strong>Cost Breakdown:</strong>
                            <ul>
                                <li>Gas: <span id="modalGasCost"></span></li>
                                <li>Exchange Fees: <span id="modalExchangeFees"></span></li>
                                <li>Flashloan Fees: <span id="modalFlashloanFees"></span></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="executeTrade" data-opportunity-id="">Execute Trade</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    
    <script>
        // Initialize feather icons
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            
            // Initialize profit chart
            initProfitChart();
            
            // Start polling for opportunities
            fetchOpportunities();
            setInterval(fetchOpportunities, 3000);
        });
        
        function initProfitChart() {
            const ctx = document.getElementById('profitChart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['1h ago', '50m ago', '40m ago', '30m ago', '20m ago', '10m ago', 'Now'],
                    datasets: [{
                        label: 'Profit Percentage',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Profit %'
                            }
                        }
                    }
                }
            });
            
            window.profitChart = chart;
        }
        
        function fetchOpportunities() {
            fetch('/api/opportunities')
                .then(response => response.json())
                .then(data => {
                    updateOpportunitiesList(data);
                    updateTopOpportunitiesTable(data);
                    updateStatistics(data);
                })
                .catch(error => console.error('Error fetching opportunities:', error));
        }
        
        function updateOpportunitiesList(opportunities) {
            const container = document.getElementById('recentOpportunities');
            
            if (opportunities.length === 0) {
                container.innerHTML = '<p class="text-muted">No opportunities found yet...</p>';
                return;
            }
            
            // Take the most recent 5 opportunities
            const recentOpps = opportunities.slice(0, 5);
            
            let html = '';
            recentOpps.forEach(opp => {
                const profitClass = opp.estimated_profit_percentage > 1 ? 'text-success' : 
                                   (opp.estimated_profit_percentage > 0 ? 'text-warning' : 'text-danger');
                
                html += `
                <div class="opportunity-item mb-2">
                    <div class="d-flex justify-content-between">
                        <div><strong>${opp.token_pair}</strong></div>
                        <div class="${profitClass}">${opp.estimated_profit_percentage.toFixed(2)}%</div>
                    </div>
                    <div class="text-muted small">
                        Buy: ${opp.buy_exchange} @ ${opp.buy_price.toFixed(6)} | 
                        Sell: ${opp.sell_exchange} @ ${opp.sell_price.toFixed(6)}
                    </div>
                    <div class="text-muted small">${new Date(opp.timestamp).toLocaleTimeString()}</div>
                </div>`;
            });
            
            container.innerHTML = html;
            
            // If there's a new profitable opportunity, show an alert
            const latestOpp = opportunities[0];
            if (latestOpp && latestOpp.estimated_profit_percentage > 0.5 && 
                latestOpp.execution_status === 'pending' && 
                !window.lastAlertedOppId || window.lastAlertedOppId !== latestOpp.id) {
                
                showOpportunityAlert(latestOpp);
                window.lastAlertedOppId = latestOpp.id;
            }
        }
        
        function updateTopOpportunitiesTable(opportunities) {
            const table = document.getElementById('topOpportunitiesTable');
            
            if (opportunities.length === 0) {
                table.innerHTML = '<tr><td colspan="5" class="text-center">No opportunities found yet</td></tr>';
                return;
            }
            
            // Sort by profit percentage descending
            const sortedOpps = [...opportunities].sort((a, b) => 
                b.estimated_profit_percentage - a.estimated_profit_percentage
            ).slice(0, 5);
            
            let html = '';
            sortedOpps.forEach(opp => {
                const profitClass = opp.estimated_profit_percentage > 1 ? 'text-success' : 
                                   (opp.estimated_profit_percentage > 0 ? 'text-warning' : 'text-danger');
                
                const btnClass = opp.execution_status === 'pending' ? 'btn-success' : 
                                (opp.execution_status === 'completed' ? 'btn-info' : 
                                (opp.execution_status === 'failed' ? 'btn-danger' : 'btn-secondary'));
                
                const btnText = opp.execution_status === 'pending' ? 'Execute' : 
                               (opp.execution_status === 'completed' ? 'Completed' : 
                               (opp.execution_status === 'failed' ? 'Failed' : 'Processing'));
                
                const isDisabled = opp.execution_status !== 'pending';
                
                html += `
                <tr>
                    <td>${opp.token_pair}</td>
                    <td>${opp.buy_exchange}<br><small>${opp.buy_price.toFixed(6)}</small></td>
                    <td>${opp.sell_exchange}<br><small>${opp.sell_price.toFixed(6)}</small></td>
                    <td class="${profitClass}">${opp.estimated_profit_percentage.toFixed(2)}%</td>
                    <td>
                        <button class="btn btn-sm ${btnClass}" ${isDisabled ? 'disabled' : ''}
                                onclick="executeTrade(${opp.id})">${btnText}</button>
                    </td>
                </tr>`;
            });
            
            table.innerHTML = html;
        }
        
        function updateStatistics(opportunities) {
            // Update the statistics cards with data from opportunities
            document.getElementById('totalOpportunities').textContent = opportunities.length;
            
            const successfulTrades = opportunities.filter(o => o.execution_status === 'completed').length;
            document.getElementById('successfulTrades').textContent = successfulTrades;
            
            // Calculate average profit percentage from successful trades
            if (successfulTrades > 0) {
                const avgProfit = opportunities
                    .filter(o => o.execution_status === 'completed')
                    .reduce((sum, o) => sum + o.estimated_profit_percentage, 0) / successfulTrades;
                document.getElementById('avgProfitPerc').textContent = avgProfit.toFixed(2) + '%';
            }
            
            // Update profit chart if we have successful trades
            if (successfulTrades > 0 && window.profitChart) {
                const profitData = opportunities
                    .filter(o => o.execution_status === 'completed')
                    .slice(0, 7)
                    .map(o => o.estimated_profit_percentage)
                    .reverse();
                
                window.profitChart.data.datasets[0].data = profitData;
                window.profitChart.update();
            }
            
            // Calculate total profit from successful trades (this would be in the quote currency)
            const totalProfit = opportunities
                .filter(o => o.execution_status === 'completed')
                .reduce((sum, o) => sum + (o.actual_profit || o.estimated_profit), 0);
            document.getElementById('totalProfit').textContent = '$' + totalProfit.toFixed(2);
        }
        
        function showOpportunityAlert(opportunity) {
            // Populate the modal with opportunity details
            document.getElementById('modalTokenPair').textContent = opportunity.token_pair;
            document.getElementById('modalBuyExchange').textContent = opportunity.buy_exchange;
            document.getElementById('modalBuyPrice').textContent = opportunity.buy_price.toFixed(6);
            document.getElementById('modalSellExchange').textContent = opportunity.sell_exchange;
            document.getElementById('modalSellPrice').textContent = opportunity.sell_price.toFixed(6);
            document.getElementById('modalPriceDiff').textContent = opportunity.price_difference_percentage.toFixed(2);
            document.getElementById('modalProfit').textContent = opportunity.estimated_profit_percentage.toFixed(2);
            document.getElementById('modalGasCost').textContent = '$' + (opportunity.gas_cost_estimate || 0).toFixed(2);
            document.getElementById('modalExchangeFees').textContent = '$' + (opportunity.exchange_fee_estimate || 0).toFixed(2);
            document.getElementById('modalFlashloanFees').textContent = '$' + (opportunity.flashloan_fee_estimate || 0).toFixed(2);
            
            // Set the opportunity ID for the execute button
            document.getElementById('executeTrade').dataset.opportunityId = opportunity.id;
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('opportunityAlert'));
            modal.show();
        }
        
        function executeTrade(opportunityId) {
            // Call the API to execute the trade
            fetch(`/api/execute_trade/${opportunityId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Refresh the opportunities data
                        fetchOpportunities();
                        
                        // If there's a modal open, close it
                        const modal = bootstrap.Modal.getInstance(document.getElementById('opportunityAlert'));
                        if (modal) {
                            modal.hide();
                        }
                        
                        // Show success message
                        alert('Trade execution initiated successfully!');
                    } else {
                        alert('Error executing trade: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error executing trade:', error);
                    alert('Error executing trade. Check console for details.');
                });
        }
        
        // Toggle scanner status
        document.getElementById('scannerStatusBtn').addEventListener('click', function() {
            const btn = this;
            const isActive = btn.classList.contains('btn-success');
            
            if (isActive) {
                // Stop the scanner
                fetch('/api/scanner/stop')
                    .then(response => response.json())
                    .then(data => {
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-danger');
                        btn.innerHTML = '<i data-feather="pause"></i> Scanner Paused';
                        feather.replace();
                        
                        document.querySelector('.scanner-status').classList.remove('alert-info');
                        document.querySelector('.scanner-status').classList.add('alert-warning');
                        document.querySelector('.scanner-status').innerHTML = 
                            '<i data-feather="alert-circle"></i> The scanner is currently paused. Click the button above to resume scanning.';
                        feather.replace();
                    });
            } else {
                // Start the scanner
                fetch('/api/scanner/start')
                    .then(response => response.json())
                    .then(data => {
                        btn.classList.remove('btn-danger');
                        btn.classList.add('btn-success');
                        btn.innerHTML = '<i data-feather="play"></i> Scanner Active';
                        feather.replace();
                        
                        document.querySelector('.scanner-status').classList.remove('alert-warning');
                        document.querySelector('.scanner-status').classList.add('alert-info');
                        document.querySelector('.scanner-status').innerHTML = 
                            '<i data-feather="info"></i> The scanner is running and checking for opportunities every <span id="scanIntervalDisplay">3</span> seconds.';
                        feather.replace();
                    });
            }
        });
        
        // Execute trade from the modal
        document.getElementById('executeTrade').addEventListener('click', function() {
            const opportunityId = this.dataset.opportunityId;
            executeTrade(opportunityId);
        });
    </script>
</body>
</html>
