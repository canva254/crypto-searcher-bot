<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Arbitrage Scanner</title>
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Crypto Arbitrage Scanner</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/opportunities">Opportunities</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settings">Settings</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-dark-subtle border-info">
                    <div class="card-header bg-info bg-opacity-25">
                        <h5 class="mb-0">Getting Started with Arbitrage Scanner</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-2">Follow these simple steps to start scanning for crypto arbitrage opportunities:</p>
                        <ol class="mb-3">
                            <li>Go to <a href="/settings">Settings</a> to configure the exchanges you want to monitor</li>
                            <li>Add token pairs that you'd like to track (default pairs are already added)</li>
                            <li>Optional: Add exchange API keys to increase rate limits and access more data</li>
                            <li>Use the controls below to start/stop the scanner and view real-time opportunities</li>
                        </ol>
                        <div class="alert alert-info mb-0">
                            <i data-feather="info" class="me-2"></i>
                            <span>The scanner needs at least 2 active exchanges to detect arbitrage opportunities. Price differences are calculated in real-time.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Latest Arbitrage Opportunities</h5>
                        <div class="d-flex">
                            <div class="form-check form-switch me-3">
                                <input class="form-check-input" type="checkbox" id="liveUpdateSwitch" checked>
                                <label class="form-check-label" for="liveUpdateSwitch">Live Updates</label>
                            </div>
                            <button id="scannerToggle" class="btn btn-sm btn-primary">
                                <i data-feather="pause" class="me-1"></i><span>Pause Scanner</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-dark">
                                <thead>
                                    <tr>
                                        <th>Pair</th>
                                        <th>Buy Exchange</th>
                                        <th>Sell Exchange</th>
                                        <th>Price Diff %</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="opportunitiesTable">
                                    <tr>
                                        <td colspan="5" class="text-center">Loading opportunities...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="text-end mt-2">
                            <a href="/opportunities" class="btn btn-sm btn-outline-info">View All Opportunities</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Scanner Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>Status:</span>
                            <span class="badge bg-success" id="scannerStatus">Running</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>Scan Interval:</span>
                            <span id="scanInterval">3 seconds</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>Min Profit Threshold:</span>
                            <span id="profitThreshold">0.5%</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Active Token Pairs:</span>
                            <span id="tokenPairCount">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Top Exchanges</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush" id="activeExchanges">
                            <li class="list-group-item bg-dark">Loading exchanges...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            
            const opportunitiesTable = document.getElementById('opportunitiesTable');
            const scannerStatus = document.getElementById('scannerStatus');
            const scanInterval = document.getElementById('scanInterval');
            const profitThreshold = document.getElementById('profitThreshold');
            const tokenPairCount = document.getElementById('tokenPairCount');
            const activeExchanges = document.getElementById('activeExchanges');
            const scannerToggle = document.getElementById('scannerToggle');
            const liveUpdateSwitch = document.getElementById('liveUpdateSwitch');
            
            let scannerRunning = true;
            let updateInterval;
            
            // Function to format currency values
            function formatCurrency(value) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                }).format(value);
            }
            
            // Function to format percentage values
            function formatPercentage(value) {
                return new Intl.NumberFormat('en-US', {
                    style: 'percent',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(value / 100);
            }
            
            // Load opportunities
            async function loadOpportunities() {
                try {
                    const response = await fetch('/api/opportunities');
                    const data = await response.json();
                    
                    if (data.length === 0) {
                        opportunitiesTable.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center">No opportunities found yet</td>
                            </tr>
                        `;
                        return;
                    }
                    
                    opportunitiesTable.innerHTML = '';
                    
                    // Only show the 5 most recent opportunities
                    const recentOpportunities = data.slice(0, 5);
                    
                    recentOpportunities.forEach(opp => {
                        const row = document.createElement('tr');
                        
                        // Determine text color based on profit percentage
                        let profitClass = 'text-info';
                        if (opp.price_difference_percentage > 1) {
                            profitClass = 'text-success';
                        } else if (opp.price_difference_percentage > 0.5) {
                            profitClass = 'text-warning';
                        }
                        
                        const time = new Date(opp.timestamp);
                        const timeStr = time.toLocaleTimeString();
                        
                        row.innerHTML = `
                            <td>${opp.token_pair}</td>
                            <td>${opp.buy_exchange}</td>
                            <td>${opp.sell_exchange}</td>
                            <td class="${profitClass}">${opp.price_difference_percentage.toFixed(2)}%</td>
                            <td>${timeStr}</td>
                        `;
                        
                        opportunitiesTable.appendChild(row);
                    });
                } catch (error) {
                    console.error('Error fetching opportunities:', error);
                }
            }
            
            // Load settings
            async function loadSettings() {
                try {
                    const response = await fetch('/api/settings');
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        const settings = data.settings;
                        scanInterval.textContent = `${settings.scan_interval} seconds`;
                        profitThreshold.textContent = `${settings.min_profit_threshold}%`;
                    }
                } catch (error) {
                    console.error('Error fetching settings:', error);
                }
            }
            
            // Load token pairs
            async function loadTokenPairs() {
                try {
                    const response = await fetch('/api/configured_token_pairs');
                    const tokenPairs = await response.json();
                    
                    const activePairs = tokenPairs.filter(pair => pair.is_active);
                    tokenPairCount.textContent = `${activePairs.length} pairs`;
                } catch (error) {
                    console.error('Error fetching token pairs:', error);
                    tokenPairCount.textContent = '0 pairs';
                }
            }
            
            // Load exchanges
            async function loadExchanges() {
                try {
                    const response = await fetch('/api/configured_exchanges');
                    const exchanges = await response.json();
                    
                    activeExchanges.innerHTML = '';
                    
                    if (exchanges.length === 0) {
                        const li = document.createElement('li');
                        li.className = 'list-group-item bg-dark text-center';
                        li.innerHTML = 'No exchanges configured. Add some in <a href="/settings">Settings</a>.';
                        activeExchanges.appendChild(li);
                        return;
                    }
                    
                    exchanges.forEach(exchange => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item bg-dark d-flex justify-content-between align-items-center';
                        li.innerHTML = `
                            <span>${exchange.exchange_name.charAt(0).toUpperCase() + exchange.exchange_name.slice(1)}</span>
                            <span class="badge bg-${exchange.is_active ? 'success' : 'secondary'}">
                                ${exchange.is_active ? 'Active' : 'Inactive'}
                            </span>
                        `;
                        activeExchanges.appendChild(li);
                    });
                } catch (error) {
                    console.error('Error fetching exchanges:', error);
                    
                    const li = document.createElement('li');
                    li.className = 'list-group-item bg-dark text-center text-danger';
                    li.innerHTML = 'Error loading exchanges';
                    activeExchanges.appendChild(li);
                }
            }
            
            // Toggle scanner
            scannerToggle.addEventListener('click', async function() {
                try {
                    if (scannerRunning) {
                        await fetch('/api/scanner/stop');
                        scannerRunning = false;
                        scannerStatus.className = 'badge bg-danger';
                        scannerStatus.textContent = 'Stopped';
                        scannerToggle.innerHTML = '<i data-feather="play" class="me-1"></i><span>Start Scanner</span>';
                    } else {
                        await fetch('/api/scanner/start');
                        scannerRunning = true;
                        scannerStatus.className = 'badge bg-success';
                        scannerStatus.textContent = 'Running';
                        scannerToggle.innerHTML = '<i data-feather="pause" class="me-1"></i><span>Pause Scanner</span>';
                    }
                    feather.replace();
                } catch (error) {
                    console.error('Error toggling scanner:', error);
                }
            });
            
            // Toggle live updates
            liveUpdateSwitch.addEventListener('change', function() {
                if (this.checked) {
                    // Enable auto-refresh
                    updateInterval = setInterval(loadOpportunities, 5000);
                } else {
                    // Disable auto-refresh
                    clearInterval(updateInterval);
                }
            });
            
            // Initial load
            loadOpportunities();
            loadSettings();
            loadTokenPairs();
            loadExchanges();
            
            // Set up auto-refresh
            updateInterval = setInterval(loadOpportunities, 5000);
        });
    </script>
</body>
</html>